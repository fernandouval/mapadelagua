"use strict";var cuencaMap=function(e){var f={};for(var t in e)f[t]=e[t];return f.parent_select="#"+f.parent_id,f.custom_color={Alta:"#ffeda0",Media:"#feb24c",Baja:"#f03b20"},f.init=function(e){f.svg=d3.select(f.parent_select).attr("width",f.width).attr("height",f.height),f.svg.selectAll("g").remove(),f.g=f.svg.append("g"),f.g1=f.g.append("g"),f.g2=f.g.append("g"),f.labels=f.g.append("g")},f.render=function(e,t,a,o){var s=d3.geoPath(),n=e,r=s.bounds(n),c=r[1][0]-r[0][0],i=r[1][1]-r[0][1],l=(r[0][0]+r[1][0])/2,d=(r[0][1]+r[1][1])/2,p=Math.max(1,Math.min(8,.9/Math.max(c/f.width,i/f.height))),u=[f.width/2-p*l,f.height/2-p*d],h=d3.zoom().scaleExtent([p,p]).on("zoom",function(){f.g.attr("transform",d3.event.transform)}),m=textures.lines().orientation("vertical","horizontal").size(5/p).strokeWidth(1.25/p).stroke(o);f.svg.call(m),f.g2.append("path").datum(e).attr("d",s).style("stroke",o).style("stroke-width",2.5/p).style("fill",m.url()),f.svg.call(h).call(h.transform,d3.zoomIdentity.translate(u[0],u[1]).scale(p)),f.renderDepartamentos(t,a,p)},f.renderDepartamentos=function(e,t,a){var o=d3.geoPath().projection(t);f.g1.selectAll("path").data(e.features).enter().append("path").style("fill","rgba(17, 17, 17, 0.25)").style("stroke","#111").style("stroke-width",2.5/a).attr("id",function(e,t){return t}).attr("d",o),f.labels.selectAll("text").data(e.features).enter().append("text").text(function(e){return e.properties.name}).attr("font-size",15/a+"px").attr("fill","#fff").attr("id",function(e,t){return e.centroid=o.centroid(e),"label-"+t}).attr("x",function(e){return e.centroid[0]}).attr("y",function(e){return e.centroid[1]}).style("text-anchor","middle")},f.init(),f},topogramAgua=function(e){var p={};for(var t in e)p[t]=e[t];return p.parent_select="#"+p.parent_id,p.url_topo="data/cuencas_uruguay_UH.topojson",p.url_deps="data/deptos_uy.topojson",p.url_base="data/disponibilidad01Q.topojson",p.url_licencias="data/Permisos-de-agua-2011-2018-OP-parcial.csv",p.center=[-56,-32.5],p.scale=9e3,p.body=d3.select("body"),p.stat=d3.select("#status"),p.filter_dh={Alta:!0,Media:!0,Baja:!0},p.custom_color={8:"#A5D969",7:"#C0DE67",6:"#DEE364",5:"#E9D261",4:"#EEB85E",3:"#F49A5A",2:"#F97857",1:"#FF5252"},p.data={cuencas:{},empresas:{},departamentos:{},licencias:[]},p.current_search={all_filters:{},filters:{tipos:{},usos:{},deptos:{},destinos:{},niveles:{},empresas:{}},selected:{deptos:"todos",empresas:"todos",tipos:"todos",usos:"todos",destinos:"todos",niveles:"todos"},last_selected:""},p.new_colors={1:"#ff5353",2:"#fdae61",3:"#ffeda0",4:"#a6d96a",undefined:"#4077ba"},p.map_priorizacion={1:"Muy Alta",2:"Alta",3:"Media",4:"Baja"},p.transform=d3.zoomIdentity,p.init=function(){$(window).width()<768&&(p.width=$(window).width()),p.projection=d3.geoMercator().scale(p.scale).center(p.center).translate([p.width/2,p.height/2]),p.path=d3.geoPath().projection(p.projection),p.cartogram=d3.cartogram().projection(p.projection).properties(function(e){return e.properties}).value(function(e){return 1}),p.svg=d3.select(p.parent_select),p.g=p.svg.append("g").attr("opacity",1),p.g1=p.g.append("g").attr("opacity",1),p.g2=p.g.append("g"),p.layer=p.g1.append("g").attr("id","layer"),p.states=p.layer.append("g").attr("id","states").selectAll("path"),p.loadData(),p.zoom=d3.zoom().scaleExtent([1,8]).on("zoom",function(){p.transform=d3.event.transform,p.g.attr("transform",p.transform)}),d3.select("#btn-zoom-in").on("click",function(){p.zoom_value=d3.zoomTransform(p.svg.node()).k+.5,p.svg.transition().duration(100).call(p.zoom.scaleTo,p.zoom_value)}),d3.select("#btn-zoom-out").on("click",function(){p.zoom_value=d3.zoomTransform(p.svg.node()).k-.5,p.svg.transition().duration(100).call(p.zoom.scaleTo,p.zoom_value)}),$(window).width()<800?p.svg.on("wheel",null).on("wheel.zoom",null).on("dblclick.zoom",null).on("mousedown",null).on("mousewheel",null).on("mousemove",null).on("mousedown.zoom",null).on("mousewheel.zoom",null).on("mousemove.zoom",null).on("DOMMouseScroll.zoom",null).on("dblclick.zoom",null).on("touchstart",null).on("touchmove",null).on("touchend",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null):p.svg.call(p.zoom)},p.loadData=function(){d3.json(p.url_topo,function(e){console.log("TOPOJSON"),p.prerenderCuencas(e),d3.json(p.url_base,function(e,t){if(e)throw e;p.renderBase(t),d3.csv(p.url_licencias,function(e){p.prepareLicencias(e),p.renderCuencas("area"),p.updateForm(),p.updateResults(1),p.states.attr("id",function(e,t){return e.id=t,"path-"+e.id}).attr("a",function(e){void 0!==p.data.cuencas[parseInt(e.properties.CODIGO)]&&(p.data.cuencas[parseInt(e.properties.CODIGO)].d=e)}),$("#btn-go").click(function(){$(".landing").css("opacity",0),$(".viz-container").addClass("on"),setTimeout(function(){$(".landing").css("display","none")},250)})})})})},p.renderDepartamentos=function(e){p.geodata_deps=topojson.feature(e,e.objects.deptos),p.g2.selectAll("path").data(p.geodata_deps.features).enter().append("path").attr("fill",p.custom_color.default).style("opacity",.5).style("pointer-events","none").attr("d",p.path)},p.renderBase=function(e){p.geodata_base=topojson.feature(e,e.objects.disponibilidad01),p.g2.selectAll("path").data(p.geodata_base.features).enter().append("path").attr("fill",function(e){return p.custom_color[e.properties.classes]}).style("opacity",1).style("pointer-events","none").attr("d",p.path)},p.prerenderCuencas=function(e){p.topology=e,p.geometries=p.topology.objects.UH.geometries,p.states=p.states.data(p.cartogram.features(p.topology,p.geometries)).enter().append("path").style("opacity",.5).attr("d",p.path).on("mousemove",function(e){p.showTooltip(e)}).on("mouseout",function(){p.hideTooltip()}).on("click",function(e,t){p.showInfo(p.cuencas_feautres[t])});var t=!1;$("#check").click(function(){if(!t){t=!0,$(this).toggleClass("on");var e=$(this).hasClass("on")?"resoluciones":"area";p.renderCuencas(e,t),t=!1}})},p.prepareLicencias=function(e){(p.licencias=e).forEach(function(e){var t=e["CÓDIGO DE CUENCA"],a=e["RAZÓN SOCIAL"],o=e.DEPARTAMENTO;void 0===p.data.cuencas[parseInt(t)]&&(p.data.cuencas[parseInt(t)]={id:t,nombre:e.CUENCA,tipo_uso:{Industrial:0,"Consumo Humano":0,"Otros usos Agropecuarios":0,Riego:0,"Usos No Consuntivos":0,Minero:0,"Doméstico":0,Poblacional:0,"Energético":0,"Agrícola":0,"Otros usos":0,"No definido":0},clase:{Superficial:0,"Subterráneo":0},resolucion:{"Autorización":0,Licencia:0,Permiso:0,CONCESION:0,"EXTINCION DE PERMISO DE AGUAS":0,"EXTINCION DE CONCESION DE AGUAS":0,"EXTINCION DE PERMISO ESPECIAL":0,PERMISO:0,"PERMISO ESPECIAL":0,"REVOCACION DE PERMISO DE AGUAS":0,"RESERVA DE AGUAS":0,"SIN RESOLUCIÓN":0},dh:e["DISPONIBILIDAD HÍDRICA"],ala:e["AUTORIDAD LOCAL DEL AGUA (ALA)"],aaa:e["AUTORIDAD ADMINISTRATIVA DEL AGUA (AAA)"],departamentos:[],empresas:[],provincia:e.PROVINCIA,distrito:e.DISTRITO,nro_licencias:0,usos:{}}),p.data.cuencas[parseInt(t)].nro_licencias+=1,-1==$.inArray(o,p.data.cuencas[parseInt(t)].departamentos)&&p.data.cuencas[parseInt(t)].departamentos.push(o),-1==$.inArray(a,p.data.cuencas[parseInt(t)].empresas)&&p.data.cuencas[parseInt(t)].empresas.push(a);e["Tipo Obra"];var s="Superficial";"POZO"==e["Tipo Obra"]&&(s="Subterráneo"),p.data.cuencas[parseInt(t)].clase[s]+=1;var n=e["TIPO DE PERMISO"];p.data.cuencas[parseInt(t)].resolucion[n]+=1,void 0===p.data.empresas[a]&&(p.data.empresas[a]={name:a,ruc:e["N DE RUC"],afectados:"",conflictos:[],cuencas:[],permisos:[]}),void 0===p.data.empresas[a].permisos[parseInt(t)]&&(p.data.empresas[a].permisos[parseInt(t)]=[]),p.data.empresas[a].permisos[parseInt(t)].push(e),void 0===p.data.departamentos[o]&&(p.data.departamentos[o]={name:o,empresas:[]}),-1==$.inArray(a,p.data.departamentos[o].empresas)&&p.data.departamentos[o].empresas.push(a);var r=e.uso;p.data.cuencas[parseInt(t)].tipo_uso[r]+=1,p.updateSearch([e])}),p.current_search.all_filters=jQuery.extend(!0,{},p.current_search.filters),p.priorizacion={},d3.csv("data/priorizacion.csv",function(e){$.each(e,function(e,t){var a=parseInt(t.codigo);p.priorizacion[a]=t.priorizacion})})},p.updateForm=function(){$("#close-info").click(function(){$(".modal").hide(),$("body").removeClass("modal-active")}),$("#tab1").click(function(){$("#block1").show(),$("#block2").hide(),$(".tabs li").removeClass("selected"),$(this).addClass("selected")}),$("#tab2").click(function(){$("#block2").show(),$("#block1").hide(),$(".tabs li").removeClass("selected"),$(this).addClass("selected")})},p.updateSearch=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;Array.isArray(e)||(e=[e]),t&&(p.current_search.filters.usos={},p.current_search.filters.tipos={},p.current_search.filters.destinos={},p.current_search.filters.deptos={},p.current_search.filters.niveles={},p.current_search.filters.empresas={}),e.forEach(function(e){var t={usos:e.uso,destinos:e.destino,deptos:e.DEPARTAMENTO,tipos:e["Tipo Obra"],niveles:e.classes,empresas:e["RAZÓN SOCIAL"]};$.each(t,function(e,t){t in p.current_search.filters[e]?p.current_search.filters[e][t].count++:p.current_search.filters[e][t]={count:1}})})},p.updateResults=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;if(console.log("update RESULTS!!!"),e)p.current_search.licencias=jQuery.extend(!0,{},p.licencias);else{"todos"!=p.current_search.selected[p.current_search.last_selected]&&"niveles"!=p.current_search.last_selected||(p.current_search.licencias=p.licencias,"usos"==p.current_search.last_selected&&(p.current_search.selected.destinos="todos")),$("#results").html("");var t=p.current_search.licencias;p.current_search.licencias=[];var s=[];p.updateSearch([],1),$.each(t,function(e,t){var a={usos:t.uso,destinos:t.destino,deptos:t.DEPARTAMENTO,tipos:t["Tipo Obra"],niveles:t.classes,empresas:t["RAZÓN SOCIAL"]},o=1;$.each(p.current_search.selected,function(e,t){"todos"!=t&&t!=a[e]&&(o=0)}),o&&(s.push([t.x,t.y]),p.current_search.licencias.push(t),p.updateSearch([t]))}),p.g2.selectAll(".mark").remove(),p.g2.selectAll(".mark").data(s).enter().append("image").attr("class","mark").attr("width",10).attr("height",10).attr("xlink:href","https://cdn3.iconfinder.com/data/icons/softwaredemo/PNG/24x24/DrawingPin1_Blue.png").attr("transform",function(e){return"translate("+p.projection(e)+")"}),$("#results div").click(function(){$("#cuenca-info").show();var e=$(this).data("key");p.showInfo(p.data.cuencas[e].d)}),$("#results div").mouseover(function(){var e=$(this).data("key");p.showTooltip(p.data.cuencas[e].d,!0)}).mouseout(function(){p.hideTooltip()}),console.log(p.current_search),console.log(p.current_search.last_selected)}0==p.current_search.licencias.length?console.log("Te quedaste sin licencias!"):p.updateFilters(p.current_search.filters)},p.updateFilters=function(e){console.log(e),$(".prioridad").click(!1),$(".chosen-select").change(!1),$.each(e,function(a,t){if("niveles"==a){for(var o=0,e=function(e){e in t?(console.log(t[e].count),o+=t[e].count,$("#prioridad-"+e).fadeTo("slow",1),$("#prioridad-"+e+" span").text("("+t[e].count+") "),$("#prioridad-"+e).click(function(){$(".prioridad:not(#prioridad-"+e+")").fadeTo("slow",.4),$("#prioridad-"+e).fadeTo("slow",1),p.current_search.selected[a]=e,p.current_search.last_selected=a,p.updateResults()})):($("#prioridad-"+e).fadeTo("slow",.4),$("#prioridad-"+e+" span").text("(-) "))},s=1;s<9;s++)e(s);$("#prioridad-0 span").text("("+o+") ")}else{$("#"+a+" option").remove(),$("#"+a).append($("<option value='todos'></option>").text("todos"));if(1===Object.keys(t).length){var n=Object.keys(t)[0];$("#"+a).append($("<option value='"+n+"'></option>").text("("+t[n].count+") "+n)),$("#"+a).val(n)}else $.each(t,function(e,t){$("#"+a).append($("<option value='"+e+"'></option>").text("("+t.count+") "+e))})}})},p.showInfo=function(e){var t=d3.select("#cuenca-info");if(void 0!==p.data.cuencas[parseInt(e.properties.CODIGO)]){$(".modal").show(),$("html,body").scrollTop(0),$("body").addClass("modal-active"),$("#block-alter1").show(),$("#block-alter2").hide(),t.select(".nombre").text(e.properties.NOMBRE);var a="",o=0;$.each(p.data.cuencas[parseInt(e.properties.CODIGO)].tipo_uso,function(e,t){console.log("TOTAL "+e+": "+t),isNaN(t)||(0<t&&(a+="<span>("+t+")</span>"+e+"<br>"),o+=t)}),t.select(".tipo-uso").html(a);var s="",n={"Autorización":"Autorizaciones",Licencia:"Licencias",Permiso:"Permisos",CONCESION:"CONCESIONES","EXTINCION DE PERMISO DE AGUAS":"EXTINCIONES DE PERMISO DE AGUAS","EXTINCION DE CONCESION DE AGUAS":"EXTINCIONES DE CONCESION DE AGUAS","EXTINCION DE PERMISO ESPECIAL":"EXTINCIONES DE PERMISO ESPECIAL",PERMISO:"PERMISOS","PERMISO ESPECIAL":"PERMISOS ESPECIALES","REVOCACION DE PERMISO DE AGUAS":"REVOCACIONES DE PERMISO DE AGUAS","RESERVA DE AGUAS":"RESERVAS DE AGUAS","SIN RESOLUCIÓN":"SIN RESOLUCIONES"};$.each(p.data.cuencas[parseInt(e.properties.CODIGO)].resolucion,function(e,t){1<t?s+="<span>("+t+")</span>"+n[e]+"<br>":1==t&&(s+="<span>("+t+")</span>"+e+"<br>")}),t.select(".tipo-resolucion").html(s);var r=p.data.cuencas[parseInt(e.properties.CODIGO)].clase;bb.generate({bindto:"#chart-fuente",size:{height:160,width:p.width<400?160:200},data:{type:"pie",columns:[["Superficial",r.Superficial],["Subterráneo",r["Subterráneo"]]],colors:{Superficial:"#8da0cb","Subterráneo":"#ff4b4b"}},pie:{label:{format:function(e,t,a){return e}}},tooltip:{format:{title:function(e){return e},value:function(e,t,a){return e}}}});t.select(".total-resolucion").html("Total de resoluciones: "+o),t.select(".disponibilidad-hidrica").text(p.map_priorizacion[p.priorizacion[parseInt(e.properties.CODIGO)]]),t.select(".ala").text(p.data.cuencas[parseInt(e.properties.CODIGO)].ala),t.select(".aaa").text(p.data.cuencas[parseInt(e.properties.CODIGO)].aaa),t.select(".departamento").text(p.data.cuencas[parseInt(e.properties.CODIGO)].departamentos.join(", "));var c=p.data.cuencas[parseInt(e.properties.CODIGO)].empresas.length,i=0,l=!0;$(".empresas-conflictos").html(""),$.each(p.data.cuencas[parseInt(e.properties.CODIGO)].empresas,function(e,t){var a=p.data.empresas[t];if(""!==a.afectados||0<a.conflictos.length){i+=1;var o=$("<div></div>",{class:"item"+(l?" active":"")}),s=$("<div></div>",{class:"razon-social"}).html('<img src="dist/images/wagon.png" /> '+t),n="",r=$("<ul></ul>",{class:"conflictos"});""!==a.afectados&&(n=$("<div></div>",{class:"afectados"}).text(a.afectados)),a.conflictos.forEach(function(e){r.append($("<li></li>",{class:"conflicto"}).text(e))}),o.append(s).append(n).append(r),$(".empresas-conflictos").append(o),l=!1}}),0==i&&$.each(p.data.cuencas[parseInt(e.properties.CODIGO)].empresas,function(e,t){var a=$("<div></div>",{class:"item"}),o=$("<div></div>",{class:"razon-social"}).html('<img src="dist/images/wagon.png" /> '+t);a.append(o),$(".empresas-conflictos").append(a)}),$(".empresas-conflictos .item").click(function(){$(".empresas-conflictos .item").removeClass("active"),$(this).addClass("active")});var d="";0<c?(d=1==c?"De <span>"+c+"</span> empresa que ocupa esta cuenca":"De las <span>"+c+"</span> empresas que ocupan esta cuenca",d+=1==i?", <span>"+i+"</span> está vinculada a conflictos sociales.":", <span>"+i+"</span> están vinculadas a conflictos sociales."):d=1==i?"<span>"+c+"</span> empresa ocupa esta cuenca.":"<span>"+c+"</span> empresas ocupan esta cuenca.",$("#block2 .total").html(d),new cuencaMap({parent_id:"cuenca-map",width:$("#cuenca-map").width(),height:$("#cuenca-map").height()}).render(e,p.geodata_deps,p.projection,p.new_colors[p.priorizacion[parseInt(e.properties.CODIGO)]])}else{console.log("Sin información :",e.properties),$(".modal").show(),$("html,body").scrollTop(0),$("body").addClass("modal-active"),t.select(".nombre").text(e.properties.NOMBRE),t.select(".disponibilidad-hidrica").text(p.map_priorizacion[p.priorizacion[parseInt(e.properties.CODIGO)]]),t.select(".ala").text(""),t.select(".departamento").text(""),$("#block-alter2").show(),$("#block-alter1").hide(),new cuencaMap({parent_id:"cuenca-map",width:$("#cuenca-map").width(),height:$("#cuenca-map").height()}).render(e,p.geodata_deps,p.projection,p.new_colors[p.priorizacion[parseInt(e.properties.CODIGO)]])}},p.showTooltip=function(e,t){var a,o,s=d3.select("#map-tooltip"),n=void 0,r=void 0,c=void 0;if(t?(a=e,n=[(o=d3.select("#path-"+a.id).node().getBBox()).x+o.width/2,o.y+o.height/2],r=(n=p.transform.apply(n))[0],c=n[1]):(r=(n=d3.mouse(p.svg.node()))[0],c=n[1]-10),s.select(".nombre").text(e.properties.NOMBRE),void 0!==p.data.cuencas[parseInt(e.properties.CODIGO)]){var i="",l={"Autorización":"Autorizaciones",Licencia:"Licencias",Permiso:"Permisos",CONCESION:"CONCESIONES","EXTINCION DE PERMISO DE AGUAS":"EXTINCIONES DE PERMISO DE AGUAS","EXTINCION DE CONCESION DE AGUAS":"EXTINCIONES DE CONCESION DE AGUAS","EXTINCION DE PERMISO ESPECIAL":"EXTINCIONES DE PERMISO ESPECIAL",PERMISO:"PERMISOS","PERMISO ESPECIAL":"PERMISOS ESPECIALES","REVOCACION DE PERMISO DE AGUAS":"REVOCACIONES DE PERMISO DE AGUAS","RESERVA DE AGUAS":"RESERVAS DE AGUAS","SIN RESOLUCIÓN":"SIN RESOLUCIONES"};$.each(p.data.cuencas[parseInt(e.properties.CODIGO)].resolucion,function(e,t){1<t?i+="<span>("+t+")</span>"+l[e]+"<br>":1==t&&(i+="<span>("+t+")</span>"+e+"<br>")}),s.select(".nro").html(i)}else s.select(".nro").html("");s.style("display","block").style("left",r+"px").style("top",c+"px")},p.hideTooltip=function(){d3.select("#map-tooltip").style("display","none")},p.renderCuencas=function(t){var e=Date.now();p.body.classed("updating",!0);var a=function(e){return"area"==t?e.properties.area:void 0===p.data.cuencas[parseInt(e.properties.CODIGO)]||!1===p.filter_dh[p.data.cuencas[parseInt(e.properties.CODIGO)].DH]?0:p.data.cuencas[parseInt(e.properties.CODIGO)].nro_licencias},o=p.states.data().map(a).filter(function(e){return!isNaN(e)}).sort(d3.ascending),s=o[0],n=o[o.length-1],r=d3.scaleLinear().domain([s,n]).range([1,700]);p.cartogram.value(function(e){return r(a(e))});var c=p.cartogram(p.topology,p.geometries).features;"area"==t&&(p.cuencas_feautres=c),p.states.data(c),p.states.transition().duration(750).ease(d3.easeLinear).attr("d",p.cartogram.path);var i=(Date.now()-e)/1e3;p.stat.text(["calculated in",i.toFixed(1),"seconds"].join(" ")),p.body.classed("updating",!1)},p.init(),p},topogram_agua=new topogramAgua({parent_id:"map",width:$("#map").width(),height:$("#map").height()});$(".counter").each(function(){var s=$(this),e="https://graph.facebook.com/?access_token=1501553810140130|FZfZzc8CSIWFR-rPJUCWJnG4cdE&id="+s.attr("url");$.getJSON(e,function(e){if(void 0!==e.share){var t=e.share.share_count,a=""+t%1e3,o="000".substring(0,"000".length-a.length)+a;t=999<t?parseInt(t/1e3)+"."+o:t,s.html(t)}})}),$(".popup").click(function(e){var t=($(window).width()-575)/2,a=($(window).height()-400)/2,o=this.href.replace(/\#/g,"%23"),s="status=1,width=575,height=400,top="+a+",left="+t;return window.open(o,"popup",s),!1});